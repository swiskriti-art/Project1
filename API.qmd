---
title: "API"
format: html
editor: visual
---

## Getting PUMS data using API

loading library

```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(lubridate)
library(stringr)

```

Helper function to parse the return data from `Get` of a URL. This function extracts the return data's content. The json content is then parsed into a matrix
```{r}
# Function to get the data from a url
# url should contain all the parameters 
get_url_data <- function(url){
  data <- httr::GET(url)
  parsed <- fromJSON(rawToChar(data$content))
  # parsed data(matrix) has column names in the fist row extract that row use it as column name of the parsed data
  dimnames(parsed)[[2]] <- parsed[1,]
  #except first row taking the rest of rows of parsed data (matrix) and turn into a tibble
  data_tbl <- as_tibble(parsed[2:nrow(parsed),])
}
```

Create factors for categorical variables
```{r}
sex_factor <- list(levels = c("1", "2"),
                   labels = c("Male", "Female"))
fer_factor <- list(levels = c("0","1", "2"), 
                   labels = c("N/A", "Yes", "No"))
hhl_factor <- list(levels = c("0", "1", "2", "3", "4", "5"), 
                   labels = c("N/A (GQ/vacant)",
                              "English Only",
                              "Spanish",
                              "Other Indo-European languages",
                              "Asian and Pacific Island languages","Other Language"))
hispeed_factor <- list(levels = c("0","1", "2"), 
                       labels = c("N/A (GQ/vacant/no paid access to the internet)",
                                  "Yes","No"))
jwtrns_factor <- list(levels = c("0","01","02","03","04","05","06","07","08", "09", "10", "11"),
                       labels = c("N/A", "Car, truck, or van", "Bus", 
                                  "Subway or elevated rail",
                                  "Long-distance train or commuter rail",
                                  "Light rail, streetcar, or trolley",
                                  "Ferryboat", "Taxicab",
                                  "Motorcycle", "Bicycle", "Walked", "Worked from home",
                                  "Other method"))
sch_factor <- list(levels = c("0", "1", "2", "3"),
                   labels = c("N/A (less than 3 years old)",
                              "No, has not attended in the last 3 months",
                              "Yes, public school or public college",
                              "Yes, private school or college or home school"))
schl_factor <- list(levels = c("16",
                              "01",
                              "04",
                              "03",
                              "07",
                              "23",
                              "19",
                              "22",
                              "10",
                              "20",
                              "0", 
                              "02",
                              "21",
                              "08",
                              "24",
                              "06",
                              "14",
                              "17",
                              "12",
                              "15",
                              "13",
                              "05",
                              "11",
                              "18",
                              "09"),
                    labels = c("Regular high school diploma",
                              "No schooling completed",
                              "Grade 1",
                              "Kindergarten",
                              "Grade 4",
                              "Professional degree beyond a bachelor's degree",
                              "1 or more years of college credit, no degree",
                              "Master's degree",
                              "Grade 7",
                              "Associate's degree",
                              "N/A (less than 3 years old)",
                              "Nursery school, preschool",
                              "Bachelor's degree",
                              "Grade 5",
                              "Doctorate degree",
                              "Grade 3",
                              "Grade 11",
                              "GED or alternative credential",
                              "Grade 9",
                              "12th grade - no diploma",
                              "Grade 10",
                              "Grade 2",
                              "Grade 8",
                              "Some college, but less than 1 year",
                              "Grade 6"))
```
Function to get the mid point of the time range in JWDP and JWAP
```{r}
mid_time <- function(time_str) {
  if(is.na(time_str)) {
    return(NA)
  }
  parts <- str_split(time_str, " to ")
  t1 <- hm(parts[[1]][1]) 
  diff <- hm(parts[[1]][2]) - t1
  
  t1$minute <- t1$minute + (diff$minute %/% 2)
  if(str_detect(time_str, "p.m.")) {
    t1 <- t1 + hm("12:00")
  }
  return(as.character(t1))
}  
```
Time mappings for JWDP and JWAP
```{r}
jwdp_map <- c("4:10 a.m. to 4:19 a.m.",
              "4:20 a.m. to 4:29 a.m.",
              "4:40 a.m. to 4:49 a.m.",
              "5:15 a.m. to 5:19 a.m.",
              "6:20 a.m. to 6:24 a.m.",
              "7:15 a.m. to 7:19 a.m.",
              "8:50 a.m. to 8:54 a.m.",
              "9:05 a.m. to 9:09 a.m.",
              "9:45 a.m. to 9:49 a.m.",
              "10:00 a.m. to 10:09 a.m.",
              "10:40 a.m. to 10:49 a.m.",
              "11:00 a.m. to 11:09 a.m.",
              "11:10 a.m. to 11:19 a.m.",
              "2:00 p.m. to 2:09 p.m.",
              "2:20 p.m. to 2:29 p.m.",
              "4:30 p.m. to 4:39 p.m.",
              "6:00 p.m. to 6:09 p.m.",
              "6:30 p.m. to 6:39 p.m.",
              "6:40 p.m. to 6:49 p.m.",
              "9:20 p.m. to 9:29 p.m.",
              "9:40 p.m. to 9:49 p.m.",
              "11:00 p.m. to 11:29 p.m.",
              "8:10 a.m. to 8:14 a.m.",
              "8:20 a.m. to 8:24 a.m.",
              "8:40 a.m. to 8:44 a.m.",
              "8:55 a.m. to 8:59 a.m.",
              "9:30 a.m. to 9:34 a.m.",
              "9:55 a.m. to 9:59 a.m.",
              "1:30 p.m. to 1:39 p.m.",
              "1:40 p.m. to 1:49 p.m.",
              "2:10 p.m. to 2:19 p.m.",
              "2:40 p.m. to 2:49 p.m.",
              "3:20 p.m. to 3:29 p.m.",
              "4:10 p.m. to 4:19 p.m.",
              "6:10 p.m. to 6:19 p.m.",
              "11:30 p.m. to 11:59 p.m.",
               NA_character_, 
              "3:30 a.m. to 3:39 a.m.",
              "3:40 a.m. to 3:49 a.m.",
              "5:00 a.m. to 5:04 a.m.",
              "5:45 a.m. to 5:49 a.m.",
              "7:05 a.m. to 7:09 a.m.",
              "7:10 a.m. to 7:14 a.m.",
              "7:20 a.m. to 7:24 a.m.",
              "7:30 a.m. to 7:34 a.m.",
              "7:50 a.m. to 7:54 a.m.",
              "8:00 a.m. to 8:04 a.m.",
              "8:05 a.m. to 8:09 a.m.",
              "10:50 a.m. to 10:59 a.m.",
              "11:50 a.m. to 11:59 a.m.",
              "12:10 p.m. to 12:19 p.m.",
              "3:10 p.m. to 3:19 p.m.",
              "3:30 p.m. to 3:39 p.m.",
              "4:50 p.m. to 4:59 p.m.",
              "6:50 p.m. to 6:59 p.m.",
              "7:00 p.m. to 7:29 p.m.",
              "7:30 p.m. to 7:59 p.m.",
              "3:20 a.m. to 3:29 a.m.",
              "5:20 a.m. to 5:24 a.m.",
              "6:00 a.m. to 6:04 a.m.",
              "6:35 a.m. to 6:39 a.m.",
              "6:45 a.m. to 6:49 a.m.",
              "7:35 a.m. to 7:39 a.m.",
              "8:25 a.m. to 8:29 a.m.",
              "8:35 a.m. to 8:39 a.m.",
              "8:45 a.m. to 8:49 a.m.",
              "9:00 a.m. to 9:04 a.m.",
              "9:10 a.m. to 9:14 a.m.",
              "10:30 a.m. to 10:39 a.m.",
              "12:40 p.m. to 12:49 p.m.",
              "12:50 p.m. to 12:59 p.m.",
              "1:00 p.m. to 1:09 p.m.",
              "4:40 p.m. to 4:49 p.m.",
              "5:00 p.m. to 5:09 p.m.",
              "8:00 p.m. to 8:29 p.m.",
              "1:00 a.m. to 1:29 a.m.",
              "6:10 a.m. to 6:14 a.m.",
              "6:25 a.m. to 6:29 a.m.",
              "6:50 a.m. to 6:54 a.m.",
              "8:30 a.m. to 8:34 a.m.",
              "10:20 a.m. to 10:29 a.m.",
              "12:20 p.m. to 12:29 p.m.",
              "1:10 p.m. to 1:19 p.m.",
              "1:50 p.m. to 1:59 p.m.",
              "3:00 p.m. to 3:09 p.m.",
              "4:00 p.m. to 4:09 p.m.",
              "5:50 p.m. to 5:59 p.m.",
              "10:00 p.m. to 10:09 p.m.",
              "10:20 p.m. to 10:29 p.m.",
              "12:00 a.m. to 12:29 a.m.",
              "2:30 a.m. to 2:59 a.m.",
              "3:50 a.m. to 3:59 a.m.",
              "4:00 a.m. to 4:09 a.m.",
              "4:30 a.m. to 4:39 a.m.",
              "5:30 a.m. to 5:34 a.m.",
              "5:35 a.m. to 5:39 a.m.",
              "5:55 a.m. to 5:59 a.m.",
              "9:50 a.m. to 9:54 a.m.",
              "11:20 a.m. to 11:29 a.m.",
              "11:30 a.m. to 11:39 a.m.",
              "12:30 p.m. to 12:39 p.m.",
              "2:30 p.m. to 2:39 p.m.",
              "2:50 p.m. to 2:59 p.m.",
              "5:10 p.m. to 5:19 p.m.",
              "5:20 p.m. to 5:29 p.m.",
              "5:30 p.m. to 5:39 p.m.",
              "10:10 p.m. to 10:19 p.m.",
              "12:30 a.m. to 12:59 a.m.",
              "1:30 a.m. to 1:59 a.m.",
              "2:00 a.m. to 2:29 a.m.",
              "3:00 a.m. to 3:09 a.m.",
              "5:05 a.m. to 5:09 a.m.",
              "5:10 a.m. to 5:14 a.m.",
              "5:25 a.m. to 5:29 a.m.",
              "5:40 a.m. to 5:44 a.m.",
              "6:15 a.m. to 6:19 a.m.",
              "6:40 a.m. to 6:44 a.m.",
              "6:55 a.m. to 6:59 a.m.",
              "7:00 a.m. to 7:04 a.m.",
              "7:25 a.m. to 7:29 a.m.",
              "7:40 a.m. to 7:44 a.m.",
              "8:15 a.m. to 8:19 a.m.",
              "9:25 a.m. to 9:29 a.m.",
              "9:35 a.m. to 9:39 a.m.",
              "9:40 a.m. to 9:44 a.m.",
              "12:00 p.m. to 12:09 p.m.",
              "3:40 p.m. to 3:49 p.m.",
              "4:20 p.m. to 4:29 p.m.",
              "5:40 p.m. to 5:49 p.m.",
              "6:20 p.m. to 6:29 p.m.",
              "8:30 p.m. to 8:59 p.m.",
              "9:00 p.m. to 9:09 p.m.",
              "9:30 p.m. to 9:39 p.m.",
              "3:10 a.m. to 3:19 a.m.",
              "4:50 a.m. to 4:59 a.m.",
              "5:50 a.m. to 5:54 a.m.",
              "6:05 a.m. to 6:09 a.m.",
              "6:30 a.m. to 6:34 a.m.",
              "7:45 a.m. to 7:49 a.m.",
              "7:55 a.m. to 7:59 a.m.",
              "9:15 a.m. to 9:19 a.m.",
              "9:20 a.m. to 9:24 a.m.",
              "10:10 a.m. to 10:19 a.m.",
              "11:40 a.m. to 11:49 a.m.",
              "1:20 p.m. to 1:29 p.m.",
              "3:50 p.m. to 3:59 p.m.",
              "9:10 p.m. to 9:19 p.m.",
              "9:50 p.m. to 9:59 p.m.",
              "10:30 p.m. to 10:39 p.m.",
              "10:40 p.m. to 10:49 p.m.",
              "10:50 p.m. to 10:59 p.m.") 
names(jwdp_map) <-  c("014",
                      "015",
                      "017",
                      "022",
                      "035",
                      "046",
                      "065",
                      "068",
                      "076",
                      "079",
                      "083",
                      "085",
                      "086",
                      "103",
                      "105",
                      "118",
                      "127",
                      "130",
                      "131",
                      "139",
                      "141",
                      "149",
                      "057",
                      "059",
                      "063",
                      "066",
                      "073",
                      "078",
                      "100",
                      "101",
                      "104",
                      "107",
                      "111",
                      "116",
                      "128",
                      "150",
                      "0"  ,
                      "010",
                      "011",
                      "019",
                      "028",
                      "044",
                      "045",
                      "047",
                      "049",
                      "053",
                      "055",
                      "056",
                      "084",
                      "090",
                      "092",
                      "110",
                      "112",
                      "120",
                      "132",
                      "133",
                      "134",
                      "009",
                      "023",
                      "031",
                      "038",
                      "040",
                      "050",
                      "060",
                      "062",
                      "064",
                      "067",
                      "069",
                      "082",
                      "095",
                      "096",
                      "097",
                      "119",
                      "121",
                      "135",
                      "003",
                      "033",
                      "036",
                      "041",
                      "061",
                      "081",
                      "093",
                      "098",
                      "102",
                      "109",
                      "115",
                      "126",
                      "143",
                      "145",
                      "001",
                      "006",
                      "012",
                      "013",
                      "016",
                      "025",
                      "026",
                      "030",
                      "077",
                      "087",
                      "088",
                      "094",
                      "106",
                      "108",
                      "122",
                      "123",
                      "124",
                      "144",
                      "002",
                      "004",
                      "005",
                      "007",
                      "020",
                      "021",
                      "024",
                      "027",
                      "034",
                      "039",
                      "042",
                      "043",
                      "048",
                      "051",
                      "058",
                      "072",
                      "074",
                      "075",
                      "091",
                      "113",
                      "117",
                      "125",
                      "129",
                      "136",
                      "137",
                      "140",
                      "008",
                      "018",
                      "029",
                      "032",
                      "037",
                      "052",
                      "054",
                      "070",
                      "071",
                      "080",
                      "089",
                      "099",
                      "114",
                      "138",
                      "142",
                      "146",
                      "147",
                      "148")
 
```
```{r}
jwap_map <- c("9:40 p.m. to 9:44 p.m.",
              "9:50 p.m. to 9:54 p.m.",
              "9:55 p.m. to 9:59 p.m.",
              "11:00 p.m. to 11:04 p.m.",
              "4:10 a.m. to 4:14 a.m.",
              "5:00 a.m. to 5:04 a.m.",
              "6:30 a.m. to 6:34 a.m.",
              "7:45 a.m. to 7:49 a.m.",
              "8:00 a.m. to 8:04 a.m.",
              "10:20 a.m. to 10:24 a.m.",
              "12:00 p.m. to 12:04 p.m.",
              "12:20 p.m. to 12:24 p.m.",
              "1:45 p.m. to 1:49 p.m.",
              "1:55 p.m. to 1:59 p.m.",
              "2:25 p.m. to 2:29 p.m.",
              "3:30 p.m. to 3:34 p.m.",
              "3:55 p.m. to 3:59 p.m.",
              "4:10 p.m. to 4:14 p.m.",
              "4:40 p.m. to 4:44 p.m.",
              "5:40 p.m. to 5:44 p.m.",
              "6:20 p.m. to 6:24 p.m.",
              "6:30 p.m. to 6:34 p.m.",
              "6:35 p.m. to 6:39 p.m.",
              "6:40 p.m. to 6:44 p.m.",
              "6:50 p.m. to 6:54 p.m.",
              "7:05 p.m. to 7:09 p.m.",
              "7:10 p.m. to 7:14 p.m.",
              "9:05 p.m. to 9:09 p.m.",
              "9:30 p.m. to 9:34 p.m.",
              "9:45 p.m. to 9:49 p.m.",
              "10:00 p.m. to 10:04 p.m.",
              "10:40 p.m. to 10:44 p.m.",
              "10:45 p.m. to 10:49 p.m.",
              "11:10 p.m. to 11:14 p.m.",
              "11:50 p.m. to 11:54 p.m.",
              "12:25 a.m. to 12:29 a.m.",
              "12:40 a.m. to 12:44 a.m.",
              "12:45 a.m. to 12:49 a.m.",
              "1:00 a.m. to 1:04 a.m.",
              "1:30 a.m. to 1:34 a.m.",
              "1:45 a.m. to 1:49 a.m.",
              "2:45 a.m. to 2:49 a.m.",
              "3:25 a.m. to 3:29 a.m.",
              "4:35 a.m. to 4:39 a.m.",
              "5:35 a.m. to 5:39 a.m.",
              "6:25 a.m. to 6:29 a.m.",
              "7:15 a.m. to 7:19 a.m.",
              "7:40 a.m. to 7:44 a.m.",
              "8:35 a.m. to 8:39 a.m.",
              "9:05 a.m. to 9:09 a.m.",
              "10:15 a.m. to 10:19 a.m.",
              "10:30 a.m. to 10:34 a.m.",
              "11:35 a.m. to 11:39 a.m.",
              "1:10 p.m. to 1:14 p.m.",
              "1:50 p.m. to 1:54 p.m.",
              "2:35 p.m. to 2:39 p.m.",
              "4:35 p.m. to 4:39 p.m.",
              "5:00 p.m. to 5:04 p.m.",
              "7:40 p.m. to 7:44 p.m.",
              "7:45 p.m. to 7:49 p.m.",
              "8:40 p.m. to 8:44 p.m.",
              "8:55 p.m. to 8:59 p.m.",
              "9:35 p.m. to 9:39 p.m.",
              "10:55 p.m. to 10:59 p.m.",
              "11:15 p.m. to 11:19 p.m.",
              "12:05 a.m. to 12:09 a.m.",
              "12:15 a.m. to 12:19 a.m.",
              "1:20 a.m. to 1:24 a.m.",
              "3:00 a.m. to 3:04 a.m.",
              "3:05 a.m. to 3:09 a.m.",
              "3:40 a.m. to 3:44 a.m.",
              "3:50 a.m. to 3:54 a.m.",
              "4:20 a.m. to 4:24 a.m.",
              "4:30 a.m. to 4:34 a.m.",
              "4:45 a.m. to 4:49 a.m.",
              "5:55 a.m. to 5:59 a.m.",
              "6:05 a.m. to 6:09 a.m.",
              "6:35 a.m. to 6:39 a.m.",
              "6:45 a.m. to 6:49 a.m.",
              "7:00 a.m. to 7:04 a.m.",
              "7:35 a.m. to 7:39 a.m.",
              "7:50 a.m. to 7:54 a.m.",
              "7:55 a.m. to 7:59 a.m.",
              "8:15 a.m. to 8:19 a.m.",
              "9:55 a.m. to 9:59 a.m.",
              "10:00 a.m. to 10:04 a.m.",
              "10:55 a.m. to 10:59 a.m.",
              "11:10 a.m. to 11:14 a.m.",
              "11:40 a.m. to 11:44 a.m.",
              "12:10 p.m. to 12:14 p.m.",
              "12:30 p.m. to 12:34 p.m.",
              "12:40 p.m. to 12:44 p.m.",
              "12:50 p.m. to 12:54 p.m.",
              "2:00 p.m. to 2:04 p.m.",
              "3:15 p.m. to 3:19 p.m.",
              "3:25 p.m. to 3:29 p.m.",
              "5:15 p.m. to 5:19 p.m.",
              "6:25 p.m. to 6:29 p.m.",
              "7:20 p.m. to 7:24 p.m.",
              "7:35 p.m. to 7:39 p.m.",
              "8:05 p.m. to 8:09 p.m.",
              "8:30 p.m. to 8:34 p.m.",
              "9:20 p.m. to 9:24 p.m.",
              "10:15 p.m. to 10:19 p.m.",
              "10:50 p.m. to 10:54 p.m.",
              "1:10 a.m. to 1:14 a.m.",
              "1:15 a.m. to 1:19 a.m.",
              "1:40 a.m. to 1:44 a.m.",
              "2:00 a.m. to 2:04 a.m.",
              "2:55 a.m. to 2:59 a.m.",
              "3:15 a.m. to 3:19 a.m.",
              "3:35 a.m. to 3:39 a.m.",
              "5:05 a.m. to 5:09 a.m.",
              "5:45 a.m. to 5:49 a.m.",
              "5:50 a.m. to 5:54 a.m.",
              "6:20 a.m. to 6:24 a.m.",
              "6:50 a.m. to 6:54 a.m.",
              "7:10 a.m. to 7:14 a.m.",
              "7:30 a.m. to 7:34 a.m.",
              "8:05 a.m. to 8:09 a.m.",
              "8:30 a.m. to 8:34 a.m.",
              "10:35 a.m. to 10:39 a.m.",
              "11:50 a.m. to 11:54 a.m.",
              "2:30 p.m. to 2:34 p.m.",
              "3:00 p.m. to 3:04 p.m.",
              "3:20 p.m. to 3:24 p.m.",
              "3:35 p.m. to 3:39 p.m.",
              "3:45 p.m. to 3:49 p.m.",
              "4:45 p.m. to 4:49 p.m.",
              "5:20 p.m. to 5:24 p.m.",
              "5:30 p.m. to 5:34 p.m.",
              "5:35 p.m. to 5:39 p.m.",
              "8:25 p.m. to 8:29 p.m.",
              "10:30 p.m. to 10:34 p.m.",
              "10:35 p.m. to 10:39 p.m.",
              "11:25 p.m. to 11:29 p.m.",
              "12:00 a.m. to 12:04 a.m.",
              "12:20 a.m. to 12:24 a.m.",
              "12:30 a.m. to 12:39 a.m.",
              "2:05 a.m. to 2:09 a.m.",
              "2:15 a.m. to 2:19 a.m.",
              "2:35 a.m. to 2:39 a.m.",
              "3:10 a.m. to 3:14 a.m.",
              "3:45 a.m. to 3:49 a.m.",
              "4:00 a.m. to 4:04 a.m.",
              "4:25 a.m. to 4:29 a.m.",
              "4:50 a.m. to 4:54 a.m.",
              "6:15 a.m. to 6:19 a.m.",
              "6:55 a.m. to 6:59 a.m.",
              "8:20 a.m. to 8:24 a.m.",
              "8:45 a.m. to 8:49 a.m.",
              "9:00 a.m. to 9:04 a.m.",
              "9:40 a.m. to 9:44 a.m.",
              "11:25 a.m. to 11:29 a.m.",
              "12:05 p.m. to 12:09 p.m.",
              "12:35 p.m. to 12:39 p.m.",
              "1:15 p.m. to 1:19 p.m.",
              "1:20 p.m. to 1:24 p.m.",
              "1:30 p.m. to 1:34 p.m.",
              "2:20 p.m. to 2:24 p.m.",
              "2:40 p.m. to 2:44 p.m.",
              "3:05 p.m. to 3:09 p.m.",
              "4:20 p.m. to 4:24 p.m.",
              "4:30 p.m. to 4:34 p.m.",
              "5:45 p.m. to 5:49 p.m.",
              "5:50 p.m. to 5:54 p.m.",
              "6:00 p.m. to 6:04 p.m.",
              "8:15 p.m. to 8:19 p.m.",
              "10:10 p.m. to 10:14 p.m.",
              "10:20 p.m. to 10:24 p.m.",
              "1:25 a.m. to 1:29 a.m.",
              "1:35 a.m. to 1:39 a.m.",
              "1:50 a.m. to 1:59 a.m.",
              "2:30 a.m. to 2:34 a.m.",
              "4:40 a.m. to 4:44 a.m.",
              "5:10 a.m. to 5:14 a.m.",
              "5:30 a.m. to 5:34 a.m.",
              "6:00 a.m. to 6:04 a.m.",
              "6:40 a.m. to 6:44 a.m.",
              "7:25 a.m. to 7:29 a.m.",
              "8:55 a.m. to 8:59 a.m.",
              "9:25 a.m. to 9:29 a.m.",
              "10:05 a.m. to 10:09 a.m.",
              "10:25 a.m. to 10:29 a.m.",
              "10:40 a.m. to 10:44 a.m.",
              "11:20 a.m. to 11:24 a.m.",
              "11:45 a.m. to 11:49 a.m.",
              "11:55 a.m. to 11:59 a.m.",
              "12:45 p.m. to 12:49 p.m.",
              "12:55 p.m. to 12:59 p.m.",
              "2:15 p.m. to 2:19 p.m.",
              "3:10 p.m. to 3:14 p.m.",
              "5:05 p.m. to 5:09 p.m.",
              "5:10 p.m. to 5:14 p.m.",
              "5:25 p.m. to 5:29 p.m.",
              "6:05 p.m. to 6:09 p.m.",
              "6:10 p.m. to 6:14 p.m.",
              "6:15 p.m. to 6:19 p.m.",
              "6:45 p.m. to 6:49 p.m.",
              "6:55 p.m. to 6:59 p.m.",
              "8:45 p.m. to 8:49 p.m.",
              "8:50 p.m. to 8:54 p.m.",
              "9:10 p.m. to 9:14 p.m.",
              "9:15 p.m. to 9:19 p.m.",
              "9:25 p.m. to 9:29 p.m.",
              "10:05 p.m. to 10:09 p.m.",
              "10:25 p.m. to 10:29 p.m.",
              "11:20 p.m. to 11:24 p.m.",
              "11:30 p.m. to 11:34 p.m.",
              "11:35 p.m. to 11:39 p.m.",
              "11:40 p.m. to 11:44 p.m.",
              NA_character_ , 
              "12:10 a.m. to 12:14 a.m.",
              "12:50 a.m. to 12:59 a.m.",
              "3:20 a.m. to 3:24 a.m.",
              "4:15 a.m. to 4:19 a.m.",
              "4:55 a.m. to 4:59 a.m.",
              "5:15 a.m. to 5:19 a.m.",
              "5:20 a.m. to 5:24 a.m.",
              "6:10 a.m. to 6:14 a.m.",
              "7:05 a.m. to 7:09 a.m.",
              "8:50 a.m. to 8:54 a.m.",
              "9:10 a.m. to 9:14 a.m.",
              "9:50 a.m. to 9:54 a.m.",
              "10:50 a.m. to 10:54 a.m.",
              "11:15 a.m. to 11:19 a.m.",
              "11:30 a.m. to 11:34 a.m.",
              "12:25 p.m. to 12:29 p.m.",
              "1:00 p.m. to 1:04 p.m.",
              "1:05 p.m. to 1:09 p.m.",
              "1:35 p.m. to 1:39 p.m.",
              "1:40 p.m. to 1:44 p.m.",
              "2:05 p.m. to 2:09 p.m.",
              "2:45 p.m. to 2:49 p.m.",
              "2:55 p.m. to 2:59 p.m.",
              "3:40 p.m. to 3:44 p.m.",
              "4:00 p.m. to 4:04 p.m.",
              "4:05 p.m. to 4:09 p.m.",
              "4:15 p.m. to 4:19 p.m.",
              "4:50 p.m. to 4:54 p.m.",
              "4:55 p.m. to 4:59 p.m.",
              "7:00 p.m. to 7:04 p.m.",
              "7:30 p.m. to 7:34 p.m.",
              "7:50 p.m. to 7:54 p.m.",
              "7:55 p.m. to 7:59 p.m.",
              "8:00 p.m. to 8:04 p.m.",
              "8:10 p.m. to 8:14 p.m.",
              "8:20 p.m. to 8:24 p.m.",
              "8:35 p.m. to 8:39 p.m.",
              "9:00 p.m. to 9:04 p.m.",
              "11:05 p.m. to 11:09 p.m.",
              "11:45 p.m. to 11:49 p.m.",
              "11:55 p.m. to 11:59 p.m.",
              "1:05 a.m. to 1:09 a.m.",
              "2:10 a.m. to 2:14 a.m.",
              "2:20 a.m. to 2:24 a.m.",
              "2:25 a.m. to 2:29 a.m.",
              "2:40 a.m. to 2:44 a.m.",
              "2:50 a.m. to 2:54 a.m.",
              "3:30 a.m. to 3:34 a.m.",
              "3:55 a.m. to 3:59 a.m.",
              "4:05 a.m. to 4:09 a.m.",
              "5:25 a.m. to 5:29 a.m.",
              "5:40 a.m. to 5:44 a.m.",
              "7:20 a.m. to 7:24 a.m.",
              "8:10 a.m. to 8:14 a.m.",
              "8:25 a.m. to 8:29 a.m.",
              "8:40 a.m. to 8:44 a.m.",
              "9:15 a.m. to 9:19 a.m.",
              "9:20 a.m. to 9:24 a.m.",
              "9:30 a.m. to 9:34 a.m.",
              "9:35 a.m. to 9:39 a.m.",
              "9:45 a.m. to 9:49 a.m.",
              "10:10 a.m. to 10:14 a.m.",
              "10:45 a.m. to 10:49 a.m.",
              "11:00 a.m. to 11:04 a.m.",
              "11:05 a.m. to 11:09 a.m.",
              "12:15 p.m. to 12:19 p.m.",
              "1:25 p.m. to 1:29 p.m.",
              "2:10 p.m. to 2:14 p.m.",
              "2:50 p.m. to 2:54 p.m.",
              "3:50 p.m. to 3:54 p.m.",
              "4:25 p.m. to 4:29 p.m.",
              "5:55 p.m. to 5:59 p.m.",
              "7:15 p.m. to 7:19 p.m.",
              "7:25 p.m. to 7:29 p.m.")
names(jwap_map) <- c("258",
                    "260",
                    "261",
                    "274",
                    "048",
                    "058",
                    "076",
                    "091",
                    "094",
                    "122",
                    "142",
                    "146",
                    "163",
                    "165",
                    "171",
                    "184",
                    "189",
                    "192",
                    "198",
                    "210",
                    "218",
                    "220",
                    "221",
                    "222",
                    "224",
                    "227",
                    "228",
                    "251",
                    "256",
                    "259",
                    "262",
                    "270",
                    "271",
                    "276",
                    "284",
                    "006",
                    "008",
                    "009",
                    "011",
                    "017",
                    "020",
                    "031",
                    "039",
                    "053",
                    "065",
                    "075",
                    "085",
                    "090",
                    "101",
                    "107",
                    "121",
                    "124",
                    "137",
                    "156",
                    "164",
                    "173",
                    "197",
                    "202",
                    "234",
                    "235",
                    "246",
                    "249",
                    "257",
                    "273",
                    "277",
                    "002",
                    "004",
                    "015",
                    "034",
                    "035",
                    "042",
                    "044",
                    "050",
                    "052",
                    "055",
                    "069",
                    "071",
                    "077",
                    "079",
                    "082",
                    "089",
                    "092",
                    "093",
                    "097",
                    "117",
                    "118",
                    "129",
                    "132",
                    "138",
                    "144",
                    "148",
                    "150",
                    "152",
                    "166",
                    "181",
                    "183",
                    "205",
                    "219",
                    "230",
                    "233",
                    "239",
                    "244",
                    "254",
                    "265",
                    "272",
                    "013",
                    "014",
                    "019",
                    "022",
                    "033",
                    "037",
                    "041",
                    "059",
                    "067",
                    "068",
                    "074",
                    "080",
                    "084",
                    "088",
                    "095",
                    "100",
                    "125",
                    "140",
                    "172",
                    "178",
                    "182",
                    "185",
                    "187",
                    "199",
                    "206",
                    "208",
                    "209",
                    "243",
                    "268",
                    "269",
                    "279",
                    "001",
                    "005",
                    "007",
                    "023",
                    "025",
                    "029",
                    "036",
                    "043",
                    "046",
                    "051",
                    "056",
                    "073",
                    "081",
                    "098",
                    "103",
                    "106",
                    "114",
                    "135",
                    "143",
                    "149",
                    "157",
                    "158",
                    "160",
                    "170",
                    "174",
                    "179",
                    "194",
                    "196",
                    "211",
                    "212",
                    "214",
                    "241",
                    "264",
                    "266",
                    "016",
                    "018",
                    "021",
                    "028",
                    "054",
                    "060",
                    "064",
                    "070",
                    "078",
                    "087",
                    "105",
                    "111",
                    "119",
                    "123",
                    "126",
                    "134",
                    "139",
                    "141",
                    "151",
                    "153",
                    "169",
                    "180",
                    "203",
                    "204",
                    "207",
                    "215",
                    "216",
                    "217",
                    "223",
                    "225",
                    "247",
                    "248",
                    "252",
                    "253",
                    "255",
                    "263",
                    "267",
                    "278",
                    "280",
                    "281",
                    "282",
                    "0",  
                    "003",
                    "010",
                    "038",
                    "049",
                    "057",
                    "061",
                    "062",
                    "072",
                    "083",
                    "104",
                    "108",
                    "116",
                    "128",
                    "133",
                    "136",
                    "147",
                    "154",
                    "155",
                    "161",
                    "162",
                    "167",
                    "175",
                    "177",
                    "186",
                    "190",
                    "191",
                    "193",
                    "200",
                    "201",
                    "226",
                    "232",
                    "236",
                    "237",
                    "238",
                    "240",
                    "242",
                    "245",
                    "250",
                    "275",
                    "283",
                    "285",
                    "012",
                    "024",
                    "026",
                    "027",
                    "030",
                    "032",
                    "040",
                    "045",
                    "047",
                    "063",
                    "066",
                    "086",
                    "096",
                    "099",
                    "102",
                    "109",
                    "110",
                    "112",
                    "113",
                    "115",
                    "120",
                    "127",
                    "130",
                    "131",
                    "145",
                    "159",
                    "168",
                    "176",
                    "188",
                    "195",
                    "213",
                    "229",
                    "231")

```
Creating a list of JWAP, JWAP map

```{r}
#time_lst <- list(jwap = jwap_map, jwdp = jwdp_map)
jwap_map <- sapply(jwap_map, mid_time)
jwdp_map <- sapply(jwdp_map, mid_time)

```

Function to query PUMS API,
```{r}
#num_vars: Numerical variable to be return 
# cat_vars: categorical variable to be return
get_data <- function(year=2022, num_vars= c("PWGTP", "AGEP"),
                     cat_vars = c("SEX"), geo = "All", 
                     filter = list(num_filter="", cat_filter="", geo_filter="*")){
  if (year < 2010 | year > 2022) {
    stop ("year needs to be 2010-2022")
  }
  if(!is.vector(num_vars) | !is.vector(cat_vars)) {
    stop("num_vars and cat_vars both need to be vectors")
  }
  allowed_num <- c("PWGTP", "AGEP", "GASP", "GRPIP","JWAP", "JWDP", "JWMNP")
  allowed_cat <- c("FER", "HHL", "HISPEED", "JWTRNS", "SCH", "SCHL", "SEX")

  diff <- setdiff(num_vars, allowed_num)
  if(length(diff) > 0){
    stop ("unknown variable(s) given in num_vars: ", diff)
  }
  diff <- setdiff(cat_vars, allowed_cat)
  if (length(diff) > 0){
    stop ("unknown variable(s) given in cat_vars: ", diff) 
  }
  if (!(geo %in% c("All", "Region", "Division", "State"))){
    stop ("unknown geo value given: ", geo)
  }
  # Add PWGTP if not present in num_vars
  if(!( "PWGTP" %in% num_vars)) {
    num_vars <- c("PWGPT", num_vars)
  }
  get_str <- ""
  if (geo != "All"){
    geo_str <- paste0("&for=", geo, ":", filter$geo_filter)
  }
  get_str <- paste0("pums?get=",
                   paste(num_vars, collapse = ","),
                   ",",
                   paste(cat_vars, collapse = ","),
                   geo_str,
                   paste0("&", filter$num_filter),
                   paste0("&", filter$cat_filter)
                   )
  URL <- paste("https://api.census.gov/data", year,
               "acs/acs1", get_str,
               sep = "/",
               collapse="/")
  print(URL)
  tbl <- get_url_data(URL)
  #https://api.census.gov/data/2022/acs/acs1/pums?get=SEX,PWGTP,MAR&for=region:*&SCHL=
  #Adding factors for each categorical variables
  for(ct in cat_vars) {
    fac <- switch(ct,
           "SEX" = sex_factor,
           "FER" = fer_factor,
           "HHL" = hhl_factor,
           "HISPEED"= hispeed_factor,
           "JWTRNS" = jwtrns_factor,
           "SCH" = sch_factor,
           "SCHL" = schl_factor)
    # For using column names from a variable need to use !! and !!sym() for use inside factor
    tbl <- tbl |>
      mutate(!!ct := factor(!!sym(ct), levels = fac$levels, labels = fac$labels))
  }
  #Converting numerical variables' values to numbers and converting time rage vars to mid time
  tbl <- tbl |>
        mutate(across(setdiff(num_vars, c("JWAP", "JWDP")), as.numeric))
  tbl <- tbl |>
    mutate(across(starts_with("JW") & ends_with("P"), 
                      ~ifelse(cur_column() == "JWDP", jwdp_map[.], jwap_map[.])
                      ))
  
  return(tbl)
}
```
Function to get data from multiple years as one tibble
```{r}
get_data_years <- function(years, num_vars= c("PWGTP", "AGEP"),
                     cat_vars = c("SEX"), geo = "All", 
                     filter = list(num_filter="", cat_filter="", geo_filter="*")){
  if(!is.vector(years) | !is.numeric(years)) {
    stop("years needs to be a numeric vector")
  }
  combined_dt <- NULL
  for (y in years) {
    if (y < 2010 | y > 2022) {
      stop ("year needs to be 2010-2022")
    }
    dt <- get_data(year = y, num_vars = num_vars, cat_vars=cat_vars,
                           geo = geo, filter =filter)
    #Adding year in mutate 
    dt <- dt |>
      mutate(year=y)
    combined_dt <- bind_rows(combined_dt, dt)
  }
  return(combined_dt)

}

#get_data_years(years=c(2021,2022), )

```
Getting the data with a cat filter and some num_vars with multiple years
```{r}
dt_tbl <- get_data_years(years=c(2021, 2022, 2010), 
                         num_vars = c("PWGTP", "GASP", "JWAP", "JWDP"),
                         cat_vars = c("SEX","FER", "HHL"),
                         geo = "State",
                         filter = list(cat_filter="SCHL=24", num_filter="", geo_filter = "1"))
dt_tbl |>
  view()
```




